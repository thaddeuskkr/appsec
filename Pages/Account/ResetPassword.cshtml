@page
@model BookwormsOnline.Pages.Account.ResetPasswordModel
@{
    ViewData["Title"] = "Reset password";
}

<section class="auth-shell">
    <div class="auth-card">
        <div class="auth-card__header">
            <p class="eyebrow">Account Recovery</p>
            <h1>Reset password</h1>
            <p>Set a new password for your account. The reset link can be used only once.</p>
        </div>

        <form method="post" data-enhanced-form>
            <div asp-validation-summary="All" class="alert alert-danger alert-modern validation-summary mb-3" role="alert"></div>

            <input asp-for="Input.Email" type="hidden" />
            <input asp-for="Input.Code" type="hidden" />

            <div class="mb-3">
                <label asp-for="Input.Password" class="form-label"></label>
                <div class="input-group">
                    <input asp-for="Input.Password" class="form-control" autocomplete="new-password" data-password-field />
                    <button type="button" class="btn password-toggle" data-password-toggle data-target="Input_Password">
                        <i class="bi bi-eye" aria-hidden="true"></i>
                    </button>
                </div>
                <span asp-validation-for="Input.Password" class="text-danger"></span>
            </div>
            <div class="mb-3">
                <label asp-for="Input.ConfirmPassword" class="form-label"></label>
                <div class="input-group">
                    <input asp-for="Input.ConfirmPassword" class="form-control" autocomplete="new-password" data-password-field />
                    <button type="button" class="btn password-toggle" data-password-toggle data-target="Input_ConfirmPassword">
                        <i class="bi bi-eye" aria-hidden="true"></i>
                    </button>
                </div>
                <span asp-validation-for="Input.ConfirmPassword" class="text-danger"></span>
            </div>
            <div class="mb-3">
                <div class="password-guidance" id="passwordGuidance" aria-live="polite" aria-atomic="true">
                    <div class="password-guidance__header">
                        <span class="password-guidance__title">Password Strength</span>
                        <span id="passwordStrengthLabel" class="password-guidance__label">Start typing a new password</span>
                    </div>
                    <div class="progress password-strength-progress">
                        <div id="passwordStrengthBar"
                             class="progress-bar strength-weak"
                             role="progressbar"
                             aria-label="Password strength"
                             aria-valuemin="0"
                             aria-valuemax="100"
                             aria-valuenow="0"
                             style="width: 0%"></div>
                    </div>
                    <ul class="password-checklist">
                        <li class="password-checklist__item unmet" data-password-rule="min-length">
                            <i class="bi bi-circle" aria-hidden="true"></i>
                            <span>At least @Model.PasswordMinLength characters</span>
                        </li>
                        @if (Model.RequireLowercase)
                        {
                            <li class="password-checklist__item unmet" data-password-rule="lowercase">
                                <i class="bi bi-circle" aria-hidden="true"></i>
                                <span>At least one lowercase letter</span>
                            </li>
                        }
                        @if (Model.RequireUppercase)
                        {
                            <li class="password-checklist__item unmet" data-password-rule="uppercase">
                                <i class="bi bi-circle" aria-hidden="true"></i>
                                <span>At least one uppercase letter</span>
                            </li>
                        }
                        @if (Model.RequireDigit)
                        {
                            <li class="password-checklist__item unmet" data-password-rule="digit">
                                <i class="bi bi-circle" aria-hidden="true"></i>
                                <span>At least one number</span>
                            </li>
                        }
                        @if (Model.RequireSpecial)
                        {
                            <li class="password-checklist__item unmet" data-password-rule="special">
                                <i class="bi bi-circle" aria-hidden="true"></i>
                                <span>At least one special character</span>
                            </li>
                        }
                    </ul>
                </div>
            </div>

            <button type="submit" class="btn btn-primary" data-loading-text="Resetting...">Reset password</button>
        </form>
    </div>
</section>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        (() => {
            const passwordInput = document.getElementById("Input_Password");
            const strengthBar = document.getElementById("passwordStrengthBar");
            const strengthLabel = document.getElementById("passwordStrengthLabel");
            const policy = {
                minLength: @Model.PasswordMinLength,
                requireLowercase: @Model.RequireLowercase.ToString().ToLowerInvariant(),
                requireUppercase: @Model.RequireUppercase.ToString().ToLowerInvariant(),
                requireDigit: @Model.RequireDigit.ToString().ToLowerInvariant(),
                requireSpecial: @Model.RequireSpecial.ToString().ToLowerInvariant()
            };

            if (!passwordInput || !strengthBar || !strengthLabel) {
                return;
            }

            const complexityRules = [
                {
                    key: "min-length",
                    enabled: true,
                    isMet: (password) => password.length >= policy.minLength
                },
                {
                    key: "lowercase",
                    enabled: policy.requireLowercase,
                    isMet: (password) => /[a-z]/.test(password)
                },
                {
                    key: "uppercase",
                    enabled: policy.requireUppercase,
                    isMet: (password) => /[A-Z]/.test(password)
                },
                {
                    key: "digit",
                    enabled: policy.requireDigit,
                    isMet: (password) => /\d/.test(password)
                },
                {
                    key: "special",
                    enabled: policy.requireSpecial,
                    isMet: (password) => /[^A-Za-z0-9]/.test(password)
                }
            ].filter(rule => rule.enabled);

            const setRuleState = (ruleKey, isMet) => {
                const item = document.querySelector(`[data-password-rule="${ruleKey}"]`);
                if (!item) {
                    return;
                }

                item.classList.toggle("met", isMet);
                item.classList.toggle("unmet", !isMet);

                const icon = item.querySelector("i");
                if (!icon) {
                    return;
                }

                icon.classList.toggle("bi-check-circle-fill", isMet);
                icon.classList.toggle("bi-circle", !isMet);
            };

            const setStrengthTone = (tone) => {
                strengthBar.classList.remove("strength-weak", "strength-medium", "strength-strong");
                strengthBar.classList.add(tone);
            };

            const refreshPasswordGuidance = () => {
                const password = passwordInput.value || "";
                let metCount = 0;

                for (const rule of complexityRules) {
                    const met = rule.isMet(password);
                    setRuleState(rule.key, met);
                    if (met) {
                        metCount++;
                    }
                }

                const percent = complexityRules.length === 0 ? 0 : Math.round((metCount / complexityRules.length) * 100);
                strengthBar.style.width = `${percent}%`;
                strengthBar.setAttribute("aria-valuenow", String(percent));

                if (password.length === 0) {
                    strengthLabel.textContent = "Start typing a new password";
                    setStrengthTone("strength-weak");
                    return;
                }

                if (percent < 50) {
                    strengthLabel.textContent = "Weak";
                    setStrengthTone("strength-weak");
                } else if (percent < 100) {
                    strengthLabel.textContent = "Almost there";
                    setStrengthTone("strength-medium");
                } else {
                    strengthLabel.textContent = "Strong";
                    setStrengthTone("strength-strong");
                }
            };

            passwordInput.addEventListener("input", refreshPasswordGuidance);
            refreshPasswordGuidance();
        })();
    </script>
}
